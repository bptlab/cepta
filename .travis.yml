dist: trusty

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - wget
      - pkg-config

before_install:
  - wget https://github.com/bazelbuild/bazel/releases/download/0.3.1/bazel_0.3.1-linux-x86_64.deb
  - sha256sum -c ci/bazel_0.3.1-linux-x86_64.deb.sha256
  - sudo dpkg -i bazel_0.3.1-linux-x86_64.deb

jobs:
  include:
   - os: linux
     arch: amd64
   # Skip testing for ARM64 as this would require compiling
   # protoc-gen-grpc-web manually
   # - os: linux
   #   arch: arm64
   #   addons:
   #     apt:
   #       packages:
   #         - maven
   - os: osx
     # osx does not support openjdk<9
     jdk: openjdk11
   # Disable windows completely because it does not make sense
   #- os: windows
   #  # windows does not support building java out of the box
   #  language: shell

services:
  - docker

language: java
jdk:
  - openjdk8
  - openjdk11

before_script:
  # Try to start pgadmin via docker
  # As windows server cannot run linux docker containers we can only test this on linux
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then deployment/dev/devenv.sh -p test up -d pgadmin ; fi

script:
  # Test docker compose regressions
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then docker ps | grep -q pgadmin ; fi
  # Check if the project builds successfully
  - bazel test :cepta
